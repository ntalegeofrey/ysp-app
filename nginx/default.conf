server {
    listen 80;
    server_name _;

    # Use Docker's embedded DNS resolver; re-resolve every 30s
    resolver 127.0.0.11 valid=30s;

    # Define upstreams via variables so they are re-resolved
    set $frontend_upstream http://frontend:3000;
    set $backend_upstream http://backend:8080;

    # Serve the frontend app running inside the frontend container
    location / {
        proxy_pass $frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Proxy API to backend service
    location /api/ {
        # Strip /api prefix when forwarding. Note: when proxy_pass uses variables,
        # URI part replacement is disabled, so we must rewrite explicitly.
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass $backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header Authorization $http_authorization;
        proxy_cache_bypass $http_upgrade;
    }

    # Serve uploaded files from backend volume
    location /uploads/ {
        alias /opt/ysp-app/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
